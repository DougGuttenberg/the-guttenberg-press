name: Check Paper Inbox

on:
  schedule:
    - cron: '0,30 * * * *'
  workflow_dispatch:

env:
  ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
  TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
  TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
  GMAIL_USER: ${{ secrets.GMAIL_USER }}
  GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
  DOUG_EMAIL: ${{ secrets.DOUG_EMAIL }}
  TZ: America/New_York
  NODE_ENV: production
  LOG_LEVEL: info

jobs:
  check-inbox:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
      - run: npm ci
      - run: mkdir -p data/papers data/feedback data/queue data/logs
      - uses: actions/download-artifact@v4
        with:
          name: daily-paper-data
          path: data/
        continue-on-error: true
      - run: |
          node -e "
          import 'dotenv/config';
          import { checkInbox, extractPaperContent } from './src/lib/email-client.js';
          import { addToQueue, tomorrowStr } from './src/lib/storage.js';
          const emails = await checkInbox();
          if (emails.length === 0) { console.log('No new emails'); process.exit(0); }
          console.log('Found ' + emails.length + ' email(s)');
          for (const email of emails) {
            const content = extractPaperContent(email);
            addToQueue(tomorrowStr(), content);
            console.log('Queued: ' + content.title);
          }
          "
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: daily-paper-data
          path: data/
          retention-days: 30
          overwrite: true
